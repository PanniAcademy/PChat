<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - PChat</title>
    <link rel="stylesheet" href="chat.css">
    <script defer src="firebase.js" type="module"></script>
</head>
<body>
    <h2 id="chatWith">Chat with: </h2>
    <div id="chatBox"></div>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>

<script type="module">
document.addEventListener("DOMContentLoaded", function () {
    let params = new URLSearchParams(window.location.search);
    let contactUid = params.get("contactUid"); // Get contact UID

    if (!contactUid) {
        alert("❌ No contact selected! Redirecting...");
        window.location.href = "contacts.html";
        return;
    }

    // Get contact email from uid
    getContactEmail(contactUid).then(contactEmail => {
        document.getElementById("chatWith").textContent = "Chat with: " + contactEmail;
        loadChat(contactUid);
    });

    document.getElementById("sendBtn").addEventListener("click", function () {
        sendMessage(contactUid);
    });
});

async function getContactEmail(contactUid) {
    let contactRef = window.firestore.doc(window.db, "contacts", contactUid);
    let docSnap = await window.firestore.getDoc(contactRef);
    if (docSnap.exists()) {
        return docSnap.data().email;
    } else {
        return "Unknown";
    }
}

function generateChatID(uid1, uid2) {
    return [uid1, uid2].sort().join("_");
}

async function sendMessage(contactUid) {
    let message = document.getElementById("messageInput").value.trim();
    if (!message) {
        alert("❌ Enter a message!");
        return;
    }

    let user = window.auth.currentUser;
    if (!user) {
        alert("❌ No user logged in! Redirecting...");
        window.location.href = "login.html";
        return;
    }

    try {
        let chatID = generateChatID(user.uid, contactUid);
        let chatRef = window.firestore.doc(window.db, "chats", chatID);

        let docSnap = await window.firestore.getDoc(chatRef);
        if (!docSnap.exists()) {
            await window.firestore.setDoc(chatRef, { messages: [], user1Uid: user.uid, user2Uid: contactUid });
        }

        await window.firestore.updateDoc(chatRef, {
            messages: window.firestore.arrayUnion({
                senderUid: user.uid,
                text: message,
                timestamp: Date.now()
            })
        });

        document.getElementById("messageInput").value = "";
    } catch (error) {
        alert("❌ Error sending message: " + error.message);
    }
}

function loadChat(contactUid) {
    let user = window.auth.currentUser;
    if (!user) return;

    let chatID = generateChatID(user.uid, contactUid);
    let chatRef = window.firestore.doc(window.db, "chats", chatID);
    let chatBox = document.getElementById("chatBox");

    window.firestore.onSnapshot(chatRef, (docSnap) => {
        chatBox.innerHTML = "";

        if (docSnap.exists()) {
            let messages = docSnap.data().messages || [];

            messages.forEach(msg => {
                let div = document.createElement("div");
                div.textContent = `${msg.senderUid === user.uid ? "You" : contactUid}: ${msg.text}`;
                div.classList.add("message");

                if (msg.senderUid === user.uid) {
                    div.classList.add("sent");
                } else {
                    div.classList.add("received");
                }

                chatBox.appendChild(div);
            });

            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }, (error) => {
        alert("❌ Error loading messages: " + error.message);
    });
}
</script>
</body>
</html>
