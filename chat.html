<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PChat - Chat</title>
    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        const params = new URLSearchParams(window.location.search);
        const recipientEmail = params.get("email");
        let userEmail = null;

        document.addEventListener("DOMContentLoaded", () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userEmail = user.email;
                    document.getElementById("chatHeader").innerText = "Chat with " + recipientEmail;
                    console.log("✅ Logged in as:", userEmail);
                    loadMessages(); // Load messages when user is logged in
                } else {
                    alert("⚠ Please log in first.");
                    window.location.href = "login.html";
                }
            });

            document.getElementById("sendMessageBtn").addEventListener("click", sendMessage);
        });

        async function sendMessage() {
            let msg = document.getElementById("message").value.trim();
            if (!msg) return;

            try {
                await addDoc(collection(db, "messages"), {
                    sender: userEmail,
                    recipient: recipientEmail,
                    text: msg,
                    timestamp: serverTimestamp()
                });

                alert("✅ Message sent:", msg);
                document.getElementById("message").value = ""; // Clear input after sending
            } catch (error) {
                console.error("❌ Error sending message:", error);
                alert("❌ Error: " + error.message);
            }
        }

        function loadMessages() {
            if (!userEmail || !recipientEmail) return;

            const messagesRef = collection(db, "messages");

            // Fetch messages where sender or recipient is either userEmail or recipientEmail
            const q = query(
                messagesRef,
                where("sender", "in", [userEmail, recipientEmail]),
                where("recipient", "in", [userEmail, recipientEmail]),
                orderBy("timestamp", "asc")
            );

            onSnapshot(q, (snapshot) => {
                let chatBox = document.getElementById("chatBox");
                chatBox.innerHTML = ""; // Clear chat before updating

                if (snapshot.empty) {
                    chatBox.innerHTML = "<p>No messages yet.</p>";
                    return;
                }

                snapshot.forEach(doc => {
                    let data = doc.data();
                    let msg = document.createElement("div");
                    msg.classList.add("message");
                    msg.classList.add(data.sender === userEmail ? "sent" : "received");
                    msg.innerHTML = `<span>${data.sender === userEmail ? "You" : data.sender}:</span> ${data.text}`;
                    chatBox.appendChild(msg);
                });

                chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to latest message
            }, (error) => {
                console.error("❌ Firestore Error:", error);
                alert("⚠ Could not load messages. Check Firestore rules.");
            });
        }
    </script>

    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div id="chatContainer">
        <h2 id="chatHeader">PChat - Chat</h2>
        <div id="chatBox"></div>
        <div id="messageInput">
            <input type="text" id="message" placeholder="Type a message">
            <button id="sendMessageBtn">Send</button>
        </div>
    </div>
</body>
</html>
