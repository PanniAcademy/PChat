<!DOCTYPE html>
<html lang="en">
<head>
    <title>PChat - Chat</title>
    <script type="module">
        import { auth, db, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "./firebase-config.js";

        const params = new URLSearchParams(window.location.search);
        const recipientEmail = params.get("email");
        let userEmail = null;

        document.addEventListener("DOMContentLoaded", () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    userEmail = user.email;
                    alert("✅ Logged in as: " + userEmail);
                    loadMessages();
                } else {
                    alert("⚠ Please log in first.");
                    window.location.href = "login.html";
                }
            });

            // Attach event listener to button
            document.getElementById("sendMessageBtn").addEventListener("click", sendMessage);
        });

        async function sendMessage() {
            let msg = document.getElementById("message").value.trim();
            if (!msg) return;

            try {
                await addDoc(collection(db, "messages"), {
                    sender: userEmail,
                    recipient: recipientEmail,
                    text: msg,
                    timestamp: serverTimestamp()
                });

                document.getElementById("message").value = ""; // Clear input
            } catch (error) {
                alert("❌ Error sending message: " + error.message);
            }
        }

        function loadMessages() {
            if (!userEmail || !recipientEmail) return;

            const q = query(
                collection(db, "messages"),
                where("sender", "in", [userEmail, recipientEmail]),
                where("recipient", "in", [userEmail, recipientEmail]),
                orderBy("timestamp", "asc")
            );

            onSnapshot(q, (snapshot) => {
                let chatBox = document.getElementById("chatBox");
                chatBox.innerHTML = "";

                snapshot.forEach(doc => {
                    let msg = document.createElement("p");
                    let data = doc.data();
                    msg.innerHTML = `<strong>${data.sender === userEmail ? "You" : data.sender}:</strong> ${data.text}`;
                    chatBox.appendChild(msg);
                });

                chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to latest message
            });
        }
    </script>

    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <h2>PChat - Chat</h2>
    <div id="chatBox" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
    <input type="text" id="message" placeholder="Type a message">
    <button id="sendMessageBtn">Send</button>
</body>
</html>
