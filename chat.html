<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PChat - Chat</title>
    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { 
            collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        const params = new URLSearchParams(window.location.search);
        const recipientEmail = params.get("email");
        let userEmail = null;

        document.addEventListener("DOMContentLoaded", () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userEmail = user.email;
                    document.getElementById("chatHeader").innerText = "Chat with " + recipientEmail;
                    loadMessages();
                } else {
                    alert("‚ö† Please log in first.");
                    window.location.href = "login.html";
                }
            });

            document.getElementById("sendMessageBtn").addEventListener("click", sendMessage);
        });

        async function sendMessage() {
            let msg = document.getElementById("message").value.trim();
            if (!msg) return;

            try {
                await addDoc(collection(db, "messages"), {
                    sender: userEmail,
                    recipient: recipientEmail,
                    text: msg,
                    timestamp: serverTimestamp()
                });

                document.getElementById("message").value = ""; // Clear input
                alert("‚úÖ Message sent!");
            } catch (error) {
                alert("‚ùå Error sending message: " + error.code + " - " + error.message);
            }
        }

        async function loadMessages() {
            if (!userEmail || !recipientEmail) return;

            const messagesRef = collection(db, "messages");

            const q = query(
                messagesRef,
                where("sender", "in", [userEmail, recipientEmail]),
                orderBy("timestamp", "asc")
            );

            // üî• Firestore Test Query (to check permissions)
            await testFirestoreQuery(); 

            onSnapshot(q, (snapshot) => {
                let chatBox = document.getElementById("chatBox");
                chatBox.innerHTML = "";

                if (snapshot.empty) {
                    chatBox.innerHTML = "<p>No messages found.</p>";
                    alert("‚Ñπ No messages found.");
                }

                snapshot.forEach(doc => {
                    let data = doc.data();

                    if ((data.sender === userEmail && data.recipient === recipientEmail) || 
                        (data.sender === recipientEmail && data.recipient === userEmail)) {
                        
                        let msg = document.createElement("div");
                        msg.classList.add("message");
                        msg.classList.add(data.sender === userEmail ? "sent" : "received");
                        msg.innerHTML = `<span>${data.sender === userEmail ? "You" : data.sender}:</span> ${data.text}`;
                        chatBox.appendChild(msg);
                    }
                });

                chatBox.scrollTop = chatBox.scrollHeight;
                alert("‚úÖ Messages loaded!");
            }, (error) => {
                alert("‚ùå Error fetching messages: " + error.code + " - " + error.message);
            });
        }

        async function testFirestoreQuery() {
            try {
                const messagesRef = collection(db, "messages");

                const testQuery = query(
                    messagesRef,
                    where("sender", "in", [userEmail, recipientEmail]),
                    orderBy("timestamp", "asc")
                );

                const testSnapshot = await getDocs(testQuery);
                alert("üì° Firestore Test Query Successful: Found " + testSnapshot.docs.length + " messages.");
            } catch (error) {
                alert("‚ùå Firestore Query Failed: " + error.code + " - " + error.message);
            }
        }
    </script>

    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div id="chatContainer">
        <h2 id="chatHeader">PChat - Chat</h2>
        <div id="chatBox"></div>
        <div id="messageInput">
            <input type="text" id="message" placeholder="Type a message">
            <button id="sendMessageBtn">Send</button>
        </div>
    </div>
</body>
</html>
