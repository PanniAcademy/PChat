<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - PChat</title>
    <link rel="stylesheet" href="chat.css">
    <script defer src="firebase.js" type="module"></script> <!-- ✅ Load Firebase -->
</head>
<body>
    <h2 id="chatWith">Chat with: </h2>
    <div id="chatBox"></div>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>

<script type="module">
import { doc, getDoc, updateDoc, arrayUnion, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", function () {
    let params = new URLSearchParams(window.location.search);
    let contactEmail = params.get("contact");

    if (!contactEmail) {
        alert("❌ No contact selected! Redirecting...");
        window.location.href = "contacts.html";
        return;
    }

    document.getElementById("chatWith").textContent = "Chat with: " + contactEmail;
    loadChat(contactEmail);

    document.getElementById("sendBtn").addEventListener("click", function () {
        sendMessage(contactEmail);
    });
});

// ✅ Generate Unique Chat ID
function generateChatID(email1, email2) {
    return [email1, email2].sort().join("_"); // Ensures both users see the same chat
}

async function sendMessage(contactEmail) {
    let message = document.getElementById("messageInput").value.trim();
    if (!message) {
        alert("❌ Enter a message!");
        return;
    }

    let user = window.auth.currentUser;
    if (!user) {
        alert("❌ No user logged in! Redirecting...");
        window.location.href = "login.html";
        return;
    }

    try {
        let chatID = generateChatID(user.email, contactEmail);
        let chatRef = doc(window.db, "chats", chatID);
        let docSnap = await getDoc(chatRef);

        if (!docSnap.exists()) {
            await setDoc(chatRef, { messages: [] }); // ✅ Create empty chat if it doesn't exist
        }

        await updateDoc(chatRef, {
            messages: arrayUnion({
                sender: user.email,
                text: message,
                timestamp: Date.now()
            })
        });

        document.getElementById("messageInput").value = "";
    } catch (error) {
        alert("❌ Error sending message: " + error.message);
    }
}

// ✅ Load Messages for BOTH Users in Real Time
function loadChat(contactEmail) {
    let user = window.auth.currentUser;
    if (!user) return;

    let chatID = generateChatID(user.email, contactEmail);
    let chatRef = doc(window.db, "chats", chatID);
    let chatBox = document.getElementById("chatBox");

    onSnapshot(chatRef, (docSnap) => {
        chatBox.innerHTML = ""; // Clear old messages

        if (docSnap.exists()) {
            let messages = docSnap.data().messages || [];

            messages.forEach(msg => {
                let div = document.createElement("div");
                div.textContent = `${msg.sender}: ${msg.text}`;
                div.classList.add("message");

                // ✅ Style messages based on sender
                if (msg.sender === user.email) {
                    div.classList.add("sent");
                } else {
                    div.classList.add("received");
                }

                chatBox.appendChild(div);
            });

            // ✅ Auto-scroll to the latest message
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }, (error) => {
        alert("❌ Error loading messages: " + error.message);
    });
}
</script>

</body>
</html>
