<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PChat - Chat</title>
    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { 
            collection, 
            addDoc, 
            query, 
            where, 
            orderBy, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        const params = new URLSearchParams(window.location.search);
        const recipientEmail = params.get("email");
        let userEmail = null;

        document.addEventListener("DOMContentLoaded", () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userEmail = user.email;
                    console.log("✅ Logged in as:", userEmail);

                    document.getElementById("chatHeader").innerText = "Chat with " + recipientEmail;
                    loadMessages();
                } else {
                    alert("⚠ Please log in first.");
                    window.location.href = "login.html";
                }
            });

            document.getElementById("sendMessageBtn").addEventListener("click", sendMessage);
        });

        async function sendMessage() {
            let msg = document.getElementById("message").value.trim();
            if (!msg) return;

            try {
                alert("📩 Sending message:", msg);

                await addDoc(collection(db, "messages"), {
                    sender: userEmail,
                    recipient: recipientEmail,
                    text: msg,
                    timestamp: serverTimestamp()
                });

                document.getElementById("message").value = ""; // Clear input
                alert("✅ Message sent!");
            } catch (error) {
                console.error("❌ Error sending message:", error);
                alert("❌ Error: " + error.message);
            }
        }

        function loadMessages() {
            if (!userEmail || !recipientEmail) {
               alert("⚠ ERROR: userEmail or recipientEmail is missing.");
                return;
            }

            console.log(`🔄 Fetching messages between ${userEmail} and ${recipientEmail}`);

            const messagesRef = collection(db, "messages");

            const q = query(
                messagesRef,
                where("sender", "in", [userEmail, recipientEmail]),
                where("recipient", "in", [userEmail, recipientEmail]),
                orderBy("timestamp", "asc")
            );

            let chatBox = document.getElementById("chatBox");
            chatBox.innerHTML = "<p>Loading messages...</p>";

            onSnapshot(q, (snapshot) => {
                alert("📡 Firestore snapshot triggered!");

                chatBox.innerHTML = ""; // Clear previous messages

                if (snapshot.empty) {
                    chatBox.innerHTML = "<p>No messages yet. Say hello! 👋</p>";
                    alert("ℹ No messages found.");
                } else {
                    snapshot.forEach(doc => {
                        let data = doc.data();
                        alert("📨 Message received from Firestore:", data);

                        let msg = document.createElement("div");
                        msg.classList.add("message");
                        msg.classList.add(data.sender === userEmail ? "sent" : "received");
                        msg.innerHTML = `<span>${data.sender === userEmail ? "You" : data.sender}:</span> ${data.text}`;
                        chatBox.appendChild(msg);
                    });

                    chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to latest message
                }
            }, (error) => {
                alert("❌ Error fetching messages:", error);
                //alert("❌ Error loading messages. Check console.");
            });
        }
    </script>

    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div id="chatContainer">
        <h2 id="chatHeader">PChat - Chat</h2>
        <div id="chatBox"></div>
        <div id="messageInput">
            <input type="text" id="message" placeholder="Type a message">
            <button id="sendMessageBtn">Send</button>
        </div>
    </div>
</body>
</html>
