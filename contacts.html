<!DOCTYPE html>
<html lang="en">
<head>
    <title>PChat - Contacts</title>
    <script type="module" src="./firebase-config.js"></script>

    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { collection, addDoc, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        let userEmail = null;

        // Wait for Firebase Auth to be ready
        auth.onAuthStateChanged(user => {
            if (user) {
                userEmail = user.email;
                alert("âœ… Logged in as:", userEmail);
                loadContacts();
            } else {
                alert("âš  Please log in first.");
                window.location.href = "login.html";
            }
        });

        async function addContact() {
            let contactEmail = document.getElementById("contactEmail").value.trim();

            if (!contactEmail || contactEmail === userEmail) {
                alert("âš  Enter a valid email (not your own)!");
                return;
            }

            try {
                // Check if the contact already exists
                const contactQuery = query(collection(db, "contacts"), where("owner", "==", userEmail), where("contact", "==", contactEmail));
                const querySnapshot = await getDocs(contactQuery);

                if (!querySnapshot.empty) {
                    alert("âš  Contact already exists!");
                    return;
                }

                // Add contact to Firestore
                await addDoc(collection(db, "contacts"), {
                    owner: userEmail,
                    contact: contactEmail
                });

                alert("âœ… Contact added successfully!");
                document.getElementById("contactEmail").value = ""; // Clear input field
            } catch (error) {
                console.error("âŒ Error adding contact:", error);
                alert("Error: " + error.message);
            }
        }

        function loadContacts() {
            if (!userEmail) {
                alert("âš  User email not available yet.");
                return;
            }

            alert("ðŸ“‚ Loading contacts...");

            const q = query(collection(db, "contacts"), where("owner", "==", userEmail));

            onSnapshot(q, (snapshot) => {
                let list = document.getElementById("contactList");
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = "<li>No contacts added yet.</li>";
                }

                snapshot.forEach((doc) => {
                    let li = document.createElement("li");
                    let contactEmail = doc.data().contact;
                    li.innerHTML = `<a href="chat.html?email=${contactEmail}">${contactEmail}</a>`;
                    list.appendChild(li);
                });

                alert("âœ… Contacts loaded successfully.");
            });
        }

        // Make sure the button is connected to the function
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("addContactBtn").addEventListener("click", addContact);
        });

    </script>

    <link rel="stylesheet" href="contacts.css">
</head>
<body>
    <h2>PChat - Contacts</h2>
    <input type="text" id="contactEmail" placeholder="Enter Contact's Email">
    <button id="addContactBtn">Add Contact</button>
    <ul id="contactList"></ul>
</body>
</html>
