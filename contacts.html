<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PChat - Contacts</title>
    <script type="module">
        import { auth, db, onAuthStateChanged } from "./firebase-config.js";
        import { collection, addDoc, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        let userEmail = null;

        // Wait for Firebase Auth to be ready
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userEmail = user.email;
                loadContacts();
            } else {
                alert("⚠ Please log in first.");
                window.location.href = "login.html";
            }
        });

        async function addContact() {
            let contactEmail = document.getElementById("contactEmail").value.trim();
            if (!contactEmail || contactEmail === userEmail) {
                alert("⚠ Enter a valid email (not your own)!");
                return;
            }

            try {
                // Check if the contact already exists
                const contactQuery = query(collection(db, "contacts"), where("owner", "==", userEmail), where("contact", "==", contactEmail));
                const querySnapshot = await getDocs(contactQuery);

                if (!querySnapshot.empty) {
                    alert("⚠ Contact already exists!");
                    return;
                }

                // Add contact to Firestore
                await addDoc(collection(db, "contacts"), {
                    owner: userEmail,
                    contact: contactEmail
                });

                alert("✅ Contact added successfully!");
                document.getElementById("contactEmail").value = ""; // Clear input
            } catch (error) {
                console.error("❌ Error adding contact:", error);
                alert("❌ Error: " + error.message);
            }
        }

        function loadContacts() {
            if (!userEmail) return;

            const q = query(collection(db, "contacts"), where("owner", "==", userEmail));

            onSnapshot(q, (snapshot) => {
                let list = document.getElementById("contactList");
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = "<li>No contacts added yet.</li>";
                }

                snapshot.forEach((doc) => {
                    let contactEmail = doc.data().contact;
                    let li = document.createElement("li");
                    li.innerHTML = `<a href="chat.html?email=${contactEmail}">${contactEmail}</a>`;
                    list.appendChild(li);
                });
            });
        }

        window.addContact = addContact;
    </script>

    <link rel="stylesheet" href="contacts.css">
</head>
<body>
    <h2>PChat - Contacts</h2>
    <input type="text" id="contactEmail" placeholder="Enter Contact's Email">
    <button onclick="addContact()">Add Contact</button>
    <ul id="contactList"></ul>
</body>
</html>
