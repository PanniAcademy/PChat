<!DOCTYPE html>
<html>
<head>
    <title>PChat - Contacts</title>
</head>
<body>
    <h1>Your Contacts</h1>
    <input type="email" id="contactEmail" placeholder="Enter Contact's Email">
    <button id="addContactBtn">Add Contact</button>

    <h2>Saved Contacts</h2>
    <ul id="contactList"></ul>

    <script type="module">
        import { auth, db, collection, addDoc, getDocs, query, where } from './firebase.js';

        document.getElementById('addContactBtn').addEventListener("click", addContact);

        async function addContact() {
            let email = document.getElementById('contactEmail').value;
            if (!email.includes("@")) {
                alert("Enter a valid email address.");
                return;
            }

            alert("Checking if user exists..."); // Debugging alert

            try {
                // Check if the user exists in Firestore
                let usersRef = collection(db, "users");
                let q = query(usersRef, where("email", "==", email));
                let querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alert("This email is not registered on PChat.");
                    return;
                }

                alert("User found! Adding to contacts..."); // Debugging alert

                // Save the contact
                await addDoc(collection(db, "contacts"), { userEmail: auth.currentUser.email, contactEmail: email });

                alert("Contact added successfully!");
                location.reload();
            } catch (error) {
                alert("Error: " + error.message);
            }
        }

        async function loadContacts() {
            alert("Loading contacts..."); // Debugging alert
            let contactsRef = collection(db, "contacts");
            let q = query(contactsRef, where("userEmail", "==", auth.currentUser.email));
            let querySnapshot = await getDocs(q);

            let list = document.getElementById('contactList');
            list.innerHTML = "";

            querySnapshot.forEach(doc => {
                let li = document.createElement('li');
                let contactEmail = doc.data().contactEmail;
                li.innerHTML = `${contactEmail} <button onclick="startChat('${contactEmail}')">Chat</button>`;
                list.appendChild(li);
            });
        }

        function startChat(email) {
            localStorage.setItem("chatUser", email);
            location.href = "chat.html";
        }

        loadContacts();
    </script>
</body>
</html>
