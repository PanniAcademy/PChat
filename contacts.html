<!DOCTYPE html>
<html lang="en">
<head>
    <title>PChat - Contacts</title>
    <script type="module">
        import { auth, db, onAuthStateChanged, collection, addDoc, query, where, onSnapshot, getDocs } from "./firebase-config.js";

        let userEmail = null;

        document.addEventListener("DOMContentLoaded", () => {
            // Check if user is logged in
            onAuthStateChanged(auth, user => {
                if (user) {
                    userEmail = user.email;
                    alert("✅ Logged in as: " + userEmail);
                    loadContacts();
                } else {
                    alert("⚠ Please log in first.");
                    window.location.href = "login.html";
                }
            });

            // Attach event listener
            document.getElementById("addContactBtn").addEventListener("click", addContact);
        });

        async function addContact() {
            let contactEmail = document.getElementById("contactEmail").value.trim();

            if (!contactEmail || contactEmail === userEmail) {
                alert("⚠ Enter a valid email (not your own)!");
                return;
            }

            try {
                // Check if contact already exists
                const contactQuery = query(collection(db, "contacts"), where("owner", "==", userEmail), where("contact", "==", contactEmail));
                const querySnapshot = await getDocs(contactQuery);

                if (!querySnapshot.empty) {
                    alert("⚠ Contact already exists!");
                    return;
                }

                // Add contact to Firestore
                await addDoc(collection(db, "contacts"), {
                    owner: userEmail,
                    contact: contactEmail
                });

                alert("✅ Contact added successfully!");
                document.getElementById("contactEmail").value = "";
            } catch (error) {
                alert("❌ Error adding contact: " + error.message);
            }
        }

        function loadContacts() {
            if (!userEmail) return;

            const q = query(collection(db, "contacts"), where("owner", "==", userEmail));

            onSnapshot(q, (snapshot) => {
                let list = document.getElementById("contactList");
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = "<li>No contacts added yet.</li>";
                }

                snapshot.forEach((doc) => {
                    let li = document.createElement("li");
                    let contactEmail = doc.data().contact;
                    li.innerHTML = `<a href="chat.html?email=${contactEmail}">${contactEmail}</a>`;
                    list.appendChild(li);
                });

                alert("✅ Contacts loaded successfully.");
            });
        }
    </script>

    <link rel="stylesheet" href="contacts.css">
</head>
<body>
    <h2>PChat - Contacts</h2>
    <input type="text" id="contactEmail" placeholder="Enter Contact's Email">
    <button id="addContactBtn">Add Contact</button>
    <ul id="contactList"></ul>
</body>
</html>
