<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts - PChat</title>
    <link rel="stylesheet" href="style.css">
    <script defer src="firebase.js" type="module"></script> <!-- ✅ Load Firebase.js -->
</head>
<body>
    <h2>Your Contacts</h2>
    <input type="text" id="contactEmail" placeholder="Enter contact's email">
    <button id="addContactBtn">Add Contact</button>
    
    <h3>Contact List:</h3>
    <ul id="contactList"></ul>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            alert("✅ Contacts page loaded!");

            // ✅ Wait for Firebase to load the user correctly
            window.auth.onAuthStateChanged((user) => {
                if (!user) {
                    //alert("❌ No user logged in! Redirecting to login...");
                    window.location.href = "login.html";
                    return;
                }

                alert("✅ User detected: " + user.email);
                loadContacts(user);
                
                document.getElementById("addContactBtn").addEventListener("click", function () {
                    addContact(user);
                });
            });
        });

        async function addContact(user) {
            let contactEmail = document.getElementById("contactEmail").value;

            if (!contactEmail) {
                alert("❌ Enter a contact email!");
                return;
            }

            try {
                let userId = user.uid;
                let contactRef = window.db.collection("contacts").doc(userId);

                await contactRef.set({
                    contacts: window.firebase.firestore.FieldValue.arrayUnion(contactEmail)
                }, { merge: true });

                alert("✅ Contact added!");
                loadContacts(user);
            } catch (error) {
                alert("❌ Error: " + error.message);
            }
        }

        async function loadContacts(user) {
            let contactList = document.getElementById("contactList");
            contactList.innerHTML = "";

            try {
                let userId = user.uid;
                let contactRef = window.db.collection("contacts").doc(userId);
                let doc = await contactRef.get();

                if (doc.exists) {
                    let contacts = doc.data().contacts || [];
                    contacts.forEach(email => {
                        let li = document.createElement("li");
                        li.textContent = email;
                        contactList.appendChild(li);
                    });
                }
            } catch (error) {
                alert("❌ Error loading contacts: " + error.message);
            }
        }
    </script>
</body>
</html>
