<!DOCTYPE html>
<html lang="en">
<head>
    <title>Login - PChat</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="firebase-config.js"></script> <!-- Make sure this file correctly initializes Firebase -->
    <link rel="stylesheet" href="login.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="loginContainer">
        <h2>Login to PChat</h2>
        <input type="text" id="phone" placeholder="Enter phone number (e.g., +1234567890)">
        <div id="recaptcha-container"></div>
        <button id="sendOTP" onclick="sendOTP()">Send OTP</button>
        
        <input type="text" id="otp" placeholder="Enter OTP">
        <button id="verifyOTP" onclick="verifyOTP()">Verify</button>
    </div>

    <script>
        let auth;
        let confirmationResult;

        // Ensure Firebase initializes first
        document.addEventListener("DOMContentLoaded", function () {
            // Wait until Firebase is fully loaded before using auth
            firebase.auth().onAuthStateChanged(user => {
                auth = firebase.auth(); // Now it's initialized

                // Initialize Recaptcha once Firebase is ready
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier("recaptcha-container", {
                    size: "normal",
                    callback: function(response) {
                        console.log("Recaptcha solved!", response);
                    },
                    "expired-callback": function() {
                        console.log("Recaptcha expired. Please solve it again.");
                    }
                });
                recaptchaVerifier.render();
            });
        });

        async function sendOTP() {
            try {
                if (!auth) {
                    alert("Firebase is not ready yet. Please try again.");
                    return;
                }
                let phone = document.getElementById("phone").value;
                if (!phone) {
                    alert("Please enter a valid phone number.");
                    return;
                }
                confirmationResult = await auth.signInWithPhoneNumber(phone, window.recaptchaVerifier);
                alert("OTP sent! Check your messages.");
                console.log("OTP sent to:", phone);
            } catch (error) {
                console.error("Error sending OTP:", error);
                alert("Error sending OTP: " + error.message);
            }
        }

        async function verifyOTP() {
            try {
                if (!confirmationResult) {
                    alert("You need to request an OTP first.");
                    return;
                }
                let otp = document.getElementById("otp").value;
                if (!otp) {
                    alert("Please enter the OTP.");
                    return;
                }
                let result = await confirmationResult.confirm(otp);
                alert("Login successful!");
                console.log("User signed in:", result.user);
                window.location.href = "contacts.html"; // Redirect after successful login
            } catch (error) {
                console.error("Error verifying OTP:", error);
                alert("Error verifying OTP: " + error.message);
            }
        }
    </script>
</body>
</html>
